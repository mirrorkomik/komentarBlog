name: Moderasi Komentar Giscus

on:
  discussion_comment:
    types: [created]

jobs:
  moderasi:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------
      - name: Setup Data
        id: data
        run: |
          # Simpan AUTHOR
          echo "AUTHOR=${{ github.event.comment.user.login }}" >> $GITHUB_ENV

          # Encode komentar ke base64 (aman untuk multiline & karakter aneh)
          COMMENT_BASE64=$(jq -r '.comment.body' "$GITHUB_EVENT_PATH" | base64 -w0)
          echo "COMMENT_BASE64=$COMMENT_BASE64" >> $GITHUB_ENV

          # COMMENT_ID
          echo "COMMENT_ID=${{ github.event.comment.id }}" >> $GITHUB_ENV
      
          # Tentukan DISCUSSION_NUMBER
          if [ "${{ github.event.discussion.number }}" != "" ]; then
            # Root comment
            echo "DISCUSSION_NUMBER=${{ github.event.discussion.number }}" >> $GITHUB_ENV
          else
            # Reply → ambil parent comment
            PARENT_ID="${{ github.event.comment.in_reply_to_id }}"
            DISCUSSION_NUMBER=$(gh api repos/${{ github.repository }}/discussion_comments/$PARENT_ID | jq -r '.discussion_url' | sed 's|.*/discussions/||')
            echo "DISCUSSION_NUMBER=$DISCUSSION_NUMBER" >> $GITHUB_ENV
          fi

          # Tentukan TITLE
          if [ "${{ github.event.discussion.title }}" != "" ]; then
            echo "TITLE=${{ github.event.discussion.title }}" >> $GITHUB_ENV
          else
            TITLE=$(gh api repos/${{ github.repository }}/discussions/$DISCUSSION_NUMBER | jq -r '.title')
            echo "TITLE=$TITLE" >> $GITHUB_ENV
          fi

      # -----------------------------
      - name: Debug Variables
        run: |
          echo "AUTHOR=$AUTHOR"
          echo "COMMENT_BASE64=$COMMENT_BASE64"
          echo "COMMENT_ID=$COMMENT_ID"
          echo "DISCUSSION_NUMBER=$DISCUSSION_NUMBER"
          echo "TITLE=$TITLE"
          
      # -----------------------------
      - name: Lock Diskusi (Pending) hanya untuk root comment
        if: ${{ github.event.comment.in_reply_to_id == null }}
        uses: actions/github-script@v7
        with:
          script: |
            const discussion_number = parseInt(process.env.DISCUSSION_NUMBER);
            if (!isNaN(discussion_number)) {
              console.log(`Locking discussion #${discussion_number}`);
              try {
                await github.rest.discussions.lock({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  discussion_number,
                  lock_reason: "pending moderation"
                });
              } catch (error) {
                console.log("Lock failed:", error.message);
              }
            } else {
              console.log("No valid discussion_number, skipping lock");
            }

      # -----------------------------
      - name: Filter Moderasi
        id: filter
        run: |
          # Decode COMMENT dulu supaya bisa dipakai filter
          COMMENT=$(echo "$COMMENT_BASE64" | base64 --decode)
          
          # Daftar whitelist user & kata
          WHITELIST_USER="adminuser1,adminuser2"
          WHITELIST_WORDS="mantap,terima kasih,approved"
          BADWORDS="anjing,bangsat,kontol,idiot"

          # Ubah komentar jadi lowercase supaya case-insensitive
          COMMENT_LOWER=$(echo "$COMMENT" | tr '[:upper:]' '[:lower:]')
          AUTHOR_LOWER=$(echo "$AUTHOR" | tr '[:upper:]' '[:lower:]')
          
          # Whitelist user
          for user in $(echo $WHITELIST_USER | tr ',' ' '); do
            if [ "$AUTHOR_LOWER" = "$user" ]; then
              echo "status=approve" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # Whitelist kata
          for word in $(echo $WHITELIST_WORDS | tr ',' ' '); do
            if echo "$COMMENT_LOWER" | grep -q "$word"; then
              echo "status=approve" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # Badword → reject
          for bad in $(echo $BADWORDS | tr ',' ' '); do
            if echo "$COMMENT_LOWER" | grep -q "$bad"; then
              echo "status=reject" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          # Default: pending
          echo "status=pending" >> $GITHUB_OUTPUT

      # -----------------------------
      - name: Auto Approve (Root Comment Only)
        if: steps.filter.outputs.status == 'approve' && github.event.comment.in_reply_to_id == null
        uses: actions/github-script@v7
        with:
          script: |
            const discussion_number = parseInt(process.env.DISCUSSION_NUMBER);
            const commenter = github.event.comment.user.login.toLowerCase();
            const whitelist = (process.env.WHITELIST_USER || "").split(',').map(u => u.trim());

            // Cek whitelist
            if (!whitelist.includes(commenter)) {
              console.log(`User '${commenter}' not in whitelist → skipping auto approve`);
            } else if (!isNaN(discussion_number)) {
              console.log(`User '${commenter}' is whitelisted → unlocking discussion #${discussion_number}`);
              try {
                await github.rest.discussions.unlock({
                  discussion_number: discussion_number,
                  owner: context.repo.owner,
                  repo: context.repo.repo
                });
              } catch (error) {
                console.log("Auto approve failed:", error.message);
              }
            } else {
              console.log("No valid discussion_number, skipping unlock");
            }

      # -----------------------------
      - name: Auto Delete (Semua Comment)
        if: steps.filter.outputs.status == 'reject'
        uses: actions/github-script@v7
        with:
          script: |
            const comment_id = parseInt(process.env.COMMENT_ID);
            if (!isNaN(comment_id)) {
              console.log(`Deleting comment ID ${comment_id}`);
              await github.rest.discussionComments.deleteComment({
                  discussion_comment_id: comment_id,
                  owner: context.repo.owner,
                  repo: context.repo.repo
              });
            } else {
              console.log("No valid comment_id, cannot delete");
            }
            
      # -----------------------------
      - name: Auto Hide Reply Comments
        if: github.event.comment.in_reply_to_id != null
        uses: actions/github-script@v7
        with:
          script: |
            const comment_id = parseInt(process.env.COMMENT_ID);
            const commenter = github.event.comment.user.login.toLowerCase();
            const whitelist = (process.env.WHITELIST_USER || "").split(',').map(u => u.trim());
            
            if (isNaN(comment_id)) {
              console.log("No valid comment_id, cannot hide");
            } else if (whitelist.includes(commenter)) {
              console.log(`User '${commenter}' in whitelist → not hiding reply`);
            } else {
              console.log(`Hiding reply comment ID ${comment_id} from user '${commenter}'`);
              try {
                await github.rest.discussions.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  discussion_comment_id: comment_id,
                  body: github.event.comment.body,
                  hidden: true
                });
              } catch (error) {
                console.log("Auto hide failed:", error.message);
              }
            }

      # -----------------------------
      - name: Kirim Telegram (Pending)
        if: steps.filter.outputs.status == 'pending'
        env:
          GITHUB_PAT: ${{ secrets.GH_PAT }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WEBHOOK_URL: ${{ secrets.TELEGRAM_WEBHOOK_URL }} # endpoint CI4
        run: |
          REPO="${{ github.repository }}"
          DISCUSSION_URL="https://github.com/$REPO/discussions/${DISCUSSION_NUMBER}#discussioncomment-${COMMENT_ID}"
          
          # Fungsi: Escape Markdown standar + truncate 4000 karakter
          safe_markdown() {
            local input="$1"
            # Truncate maksimal 4000 karakter dulu
            local truncated=$(echo "$input" | cut -c1-4000)
            # Escape karakter Markdown
            local escaped=$(echo "$truncated" | sed -e 's/\\/\\\\/g' \
                                                     -e 's/_/\\_/g' \
                                                     -e 's/\*/\\*/g' \
                                                     -e 's/`/\\`/g' \
                                                     -e 's/{/\\{/g' \
                                                     -e 's/}/\\}/g' \
                                                     -e 's/\[/\\[/g' \
                                                     -e 's/\]/\\]/g' \
                                                     -e 's/(/\\(/g' \
                                                     -e 's/)/\\)/g' \
                                                     -e 's/#/\\#/g' \
                                                     -e 's/!/\\!/g' \
                                                     -e 's/\./\\./g' \
                                                     -e 's/-/\\-/g' \
                                                     -e 's/\+/\\+/g' \
                                                     -e 's/>/\\>/g' \
                                                     -e 's/~ /\\~/g' \
                                                     -e 's/\$/\\$/g' \
                                                     -e 's/%/\\%/g' \
                                                     -e 's/"/\\"/g' \
                                                     -e "s/'/\\'/g")
            echo "$escaped"
          }

          # Decode komentar Base64
          COMMENT=$(echo "$COMMENT_BASE64" | base64 --decode)
          SAFE_COMMENT=$(safe_markdown "$COMMENT")

          NL=$'\n'
          TEXT="🚨 *Moderasi Komentar Baru* 🚨${NL}${NL}👤 User: ${AUTHOR}${NL}📌 Diskusi: ${TITLE}${NL}${NL}💬 Komentar:${NL}${SAFE_COMMENT}"
                    
          # generate unique action key
          ACTION_APPROVE="approve_${COMMENT_ID}"
          ACTION_DELETE="delete_${COMMENT_ID}"

          # Inline button JSON (aman via jq),
          # Aing              {"text":$approve,"callback_data": ($webhook + "?data=" + $action_approve)},
          # Maung             {"text":$reject,"callback_data": ($webhook + "?data=" + $action_delete)}
          BUTTONS=$(jq -nc --arg moderat "✅ Detail" \
                           --arg approve "✅ Approve" \
                           --arg reject "❌ Delete" \
                           --arg webhook "$WEBHOOK_URL" \
                           --arg action_approve "$ACTION_APPROVE" \
                           --arg action_delete "$ACTION_DELETE" \
                           --arg urlApprove "$DISCUSSION_URL" \
                           '[
                             [
                               {"text":$moderat,"url":$urlApprove}
                             ]
                           ]')

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d parse_mode="Markdown" \
            --data-urlencode "text=$TEXT" \
            --data-urlencode "reply_markup={\"inline_keyboard\":$BUTTONS}"
            
